
#include <stdio.h>
#include <math.h>

#include "wfc.h"

// floats per vertex data
#define FPV 8
#define INPUT_FILE "test.obj"
#define OUTPUT_FILE "test.vrt"

#define NUM_MESHES 4
#define NV_0 36
#define NV_1 30
#define NV_2 12
#define NV_3 36

const char *TEXNAMES[NUM_MESHES] = {"car.png", "roof.png", "roof.png", "door.png"};
const int NUM_VERTS[NUM_MESHES] = {NV_0, NV_1, NV_2, NV_3};
const float arr0[NV_0 * FPV] = {
    -0.119864,  0.321633,  0.048764,  0.829300,  0.276500, -0.485700,  0.660662,  0.018315,
    -0.119864,  0.175826, -0.034247,  0.829300,  0.276500, -0.485700,  0.660662,  0.304150,
    -0.405877,  0.385795, -0.403051,  0.829300,  0.276500, -0.485700,  0.946496,  0.304150,
    -0.405877,  0.531601, -0.320040, -0.558900,  0.410300, -0.720600,  0.325819,  0.012115,
    -0.405877,  0.385795, -0.403051, -0.558900,  0.410300, -0.720600,  0.325819,  0.297949,
    -0.588344,  0.324953, -0.296184, -0.558900,  0.410300, -0.720600,  0.611654,  0.297949,
    -0.588344,  0.470759, -0.213173, -0.829300, -0.276500,  0.485700,  0.291715,  0.005914,
    -0.588344,  0.324953, -0.296184, -0.829300, -0.276500,  0.485700,  0.291715,  0.291748,
    -0.302332,  0.114985,  0.072620, -0.829300, -0.276500,  0.485700,  0.005880,  0.291748,
    -0.302332,  0.260791,  0.155631,  0.558900, -0.410300,  0.720600,  0.291715,  0.309752,
    -0.302332,  0.114985,  0.072620,  0.558900, -0.410300,  0.720600,  0.291715,  0.595587,
    -0.119864,  0.175826, -0.034247,  0.558900, -0.410300,  0.720600,  0.005880,  0.595587,
    -0.588344,  0.324953, -0.296184, -0.000000, -0.869000, -0.494800,  0.611654,  0.297949,
    -0.405877,  0.385795, -0.403051, -0.000000, -0.869000, -0.494800,  0.325819,  0.297949,
    -0.119864,  0.175826, -0.034247, -0.000000, -0.869000, -0.494800,  0.325819,  0.583784,
    -0.405877,  0.531601, -0.320040,  0.000000,  0.869000,  0.494800,  0.005880,  0.663795,
    -0.588344,  0.470759, -0.213173,  0.000000,  0.869000,  0.494800,  0.291715,  0.663795,
    -0.302332,  0.260791,  0.155631,  0.000000,  0.869000,  0.494800,  0.291715,  0.949630,
    -0.119864,  0.321633,  0.048764,  0.829300,  0.276500, -0.485700,  0.660662,  0.018315,
    -0.405877,  0.385795, -0.403051,  0.829300,  0.276500, -0.485700,  0.946496,  0.304150,
    -0.405877,  0.531601, -0.320040,  0.829300,  0.276500, -0.485700,  0.946496,  0.018315,
    -0.405877,  0.531601, -0.320040, -0.558900,  0.410300, -0.720600,  0.325819,  0.012115,
    -0.588344,  0.324953, -0.296184, -0.558900,  0.410300, -0.720600,  0.611654,  0.297949,
    -0.588344,  0.470759, -0.213173, -0.558900,  0.410300, -0.720600,  0.611654,  0.012115,
    -0.588344,  0.470759, -0.213173, -0.829300, -0.276500,  0.485700,  0.291715,  0.005914,
    -0.302332,  0.114985,  0.072620, -0.829300, -0.276500,  0.485700,  0.005880,  0.291748,
    -0.302332,  0.260791,  0.155631, -0.829300, -0.276500,  0.485700,  0.005880,  0.005914,
    -0.302332,  0.260791,  0.155631,  0.558900, -0.410300,  0.720600,  0.291715,  0.309752,
    -0.119864,  0.175826, -0.034247,  0.558900, -0.410300,  0.720600,  0.005880,  0.595587,
    -0.119864,  0.321633,  0.048764,  0.558900, -0.410300,  0.720600,  0.005880,  0.309752,
    -0.588344,  0.324953, -0.296184, -0.000000, -0.869000, -0.494800,  0.611654,  0.297949,
    -0.119864,  0.175826, -0.034247, -0.000000, -0.869000, -0.494800,  0.325819,  0.583784,
    -0.302332,  0.114985,  0.072620, -0.000000, -0.869000, -0.494800,  0.611654,  0.583784,
    -0.405877,  0.531601, -0.320040,  0.000000,  0.869000,  0.494800,  0.005880,  0.663795,
    -0.302332,  0.260791,  0.155631,  0.000000,  0.869000,  0.494800,  0.291715,  0.949630,
    -0.119864,  0.321633,  0.048764,  0.000000,  0.869000,  0.494800,  0.005880,  0.949630
};
const float arr1[NV_1 * FPV] = {
     0.747216, -0.187059, -0.514238,  0.000000,  0.000000, -1.000000,  1.000000,  1.000000,
    -0.552431,  0.264248, -0.514238,  0.000000,  0.000000, -1.000000,  0.000000,  0.000000,
     0.747216,  0.264248, -0.514237,  0.000000,  0.000000, -1.000000,  0.000000,  1.000000,
    -0.552431,  0.264248,  0.342479,  0.000000,  0.000000,  1.000000,  1.000000,  1.000000,
     0.747216, -0.187059,  0.342478,  0.000000,  0.000000,  1.000000,  0.000000,  0.000000,
     0.747216,  0.264248,  0.342478,  0.000000,  0.000000,  1.000000,  0.000000,  1.000000,
     0.747216,  0.264248,  0.342478,  1.000000, -0.000000,  0.000000,  1.000000,  1.000000,
     0.747216, -0.187059, -0.514238,  1.000000, -0.000000,  0.000000,  0.000000,  0.000000,
     0.747216,  0.264248, -0.514237,  1.000000, -0.000000,  0.000000,  0.000000,  1.000000,
    -0.552431, -0.187059, -0.514238, -1.000000, -0.000000,  0.000000,  1.000000,  1.000000,
    -0.552431,  0.264248,  0.342479, -1.000000, -0.000000,  0.000000,  0.000000,  0.000000,
    -0.552431,  0.264248, -0.514238, -1.000000, -0.000000,  0.000000,  0.000000,  1.000000,
     0.747216, -0.187059, -0.514238,  0.000000, -1.000000,  0.000000,  1.000000,  1.000000,
    -0.552431, -0.187059,  0.342479,  0.000000, -1.000000,  0.000000,  0.000000,  0.000000,
    -0.552431, -0.187059, -0.514238,  0.000000, -1.000000,  0.000000,  0.000000,  1.000000,
     0.747216, -0.187059, -0.514238,  0.000000,  0.000000, -1.000000,  1.000000,  1.000000,
    -0.552431, -0.187059, -0.514238,  0.000000,  0.000000, -1.000000,  1.000000,  0.000000,
    -0.552431,  0.264248, -0.514238,  0.000000,  0.000000, -1.000000,  0.000000,  0.000000,
    -0.552431,  0.264248,  0.342479,  0.000000,  0.000000,  1.000000,  1.000000,  1.000000,
    -0.552431, -0.187059,  0.342479,  0.000000,  0.000000,  1.000000,  1.000000,  0.000000,
     0.747216, -0.187059,  0.342478,  0.000000,  0.000000,  1.000000,  0.000000,  0.000000,
     0.747216,  0.264248,  0.342478,  1.000000, -0.000000,  0.000000,  1.000000,  1.000000,
     0.747216, -0.187059,  0.342478,  1.000000, -0.000000,  0.000000,  1.000000,  0.000000,
     0.747216, -0.187059, -0.514238,  1.000000, -0.000000,  0.000000,  0.000000,  0.000000,
    -0.552431, -0.187059, -0.514238, -1.000000, -0.000000,  0.000000,  1.000000,  1.000000,
    -0.552431, -0.187059,  0.342479, -1.000000, -0.000000,  0.000000,  1.000000,  0.000000,
    -0.552431,  0.264248,  0.342479, -1.000000, -0.000000,  0.000000,  0.000000,  0.000000,
     0.747216, -0.187059, -0.514238,  0.000000, -1.000000,  0.000000,  1.000000,  1.000000,
     0.747216, -0.187059,  0.342478,  0.000000, -1.000000,  0.000000,  1.000000,  0.000000,
    -0.552431, -0.187059,  0.342479,  0.000000, -1.000000,  0.000000,  0.000000,  0.000000
};
const float arr2[NV_2 * FPV] = {
     0.097392,  0.515506, -0.085879,  0.000000,  0.862600, -0.505900,  0.500000,  0.650925,
     0.747216,  0.264248, -0.514237,  0.000000,  0.862600, -0.505900,  0.999917,  0.301934,
    -0.552431,  0.264248, -0.514238,  0.000000,  0.862600, -0.505900,  0.000084,  0.301933,
     0.097392,  0.515506, -0.085879,  0.360600,  0.932700,  0.000000,  0.500000,  0.650925,
     0.747216,  0.264248,  0.342478,  0.360600,  0.932700,  0.000000,  0.999917,  0.999916,
     0.747216,  0.264248, -0.514237,  0.360600,  0.932700,  0.000000,  0.999917,  0.301934,
     0.747216,  0.264248,  0.342478,  0.000000,  0.862600,  0.505900,  0.999917,  0.999916,
     0.097392,  0.515506, -0.085879,  0.000000,  0.862600,  0.505900,  0.500000,  0.650925,
    -0.552431,  0.264248,  0.342479,  0.000000,  0.862600,  0.505900,  0.000084,  0.999916,
     0.097392,  0.515506, -0.085879, -0.360600,  0.932700,  0.000000,  0.500000,  0.650925,
    -0.552431,  0.264248, -0.514238, -0.360600,  0.932700,  0.000000,  0.000084,  0.301933,
    -0.552431,  0.264248,  0.342479, -0.360600,  0.932700,  0.000000,  0.000084,  0.999916,
};
const float arr3[NV_3 * FPV] = {
    -0.472066,  0.100575, -0.512555, -1.000000,  0.000000,  0.000000,  0.144264,  0.033998,
    -0.472066, -0.167652, -0.551755, -1.000000,  0.000000,  0.000000,  0.224963,  0.586186,
    -0.472066, -0.167652, -0.512555, -1.000000,  0.000000,  0.000000,  0.144264,  0.586186,
    -0.472066,  0.100575, -0.551755,  0.000000,  0.000000, -1.000000,  0.668527,  0.074858,
    -0.307759, -0.167652, -0.551755,  0.000000,  0.000000, -1.000000,  0.923221,  0.490638,
    -0.472066, -0.167652, -0.551755,  0.000000,  0.000000, -1.000000,  0.668527,  0.490638,
    -0.307759,  0.100575, -0.551755,  1.000000,  0.000000,  0.000000,  0.111682,  0.178530,
    -0.307759, -0.167652, -0.512555,  1.000000,  0.000000,  0.000000,  0.030983,  0.730717,
    -0.307759, -0.167652, -0.551755,  1.000000,  0.000000,  0.000000,  0.111682,  0.730717,
    -0.307759,  0.100575, -0.512555,  0.000000,  0.000000,  1.000000,  0.540409,  0.043608,
    -0.472066, -0.167652, -0.512555,  0.000000,  0.000000,  1.000000,  0.285715,  0.459388,
    -0.307759, -0.167652, -0.512555,  0.000000,  0.000000,  1.000000,  0.540409,  0.459388,
    -0.307759, -0.167652, -0.551755,  0.000000, -1.000000,  0.000000,  0.893484,  0.609537,
    -0.472066, -0.167652, -0.512555,  0.000000, -1.000000,  0.000000,  0.346702,  0.739986,
    -0.472066, -0.167652, -0.551755,  0.000000, -1.000000,  0.000000,  0.346702,  0.609537,
    -0.472066,  0.100575, -0.551755,  0.000000,  1.000000,  0.000000,  0.303733,  0.812662,
    -0.307759,  0.100575, -0.512555,  0.000000,  1.000000,  0.000000,  0.850515,  0.943111,
    -0.307759,  0.100575, -0.551755,  0.000000,  1.000000,  0.000000,  0.850515,  0.812662,
    -0.472066,  0.100575, -0.512555, -1.000000,  0.000000,  0.000000,  0.144264,  0.033998,
    -0.472066,  0.100575, -0.551755, -1.000000,  0.000000,  0.000000,  0.224963,  0.033998,
    -0.472066, -0.167652, -0.551755, -1.000000,  0.000000,  0.000000,  0.224963,  0.586186,
    -0.472066,  0.100575, -0.551755,  0.000000,  0.000000, -1.000000,  0.668527,  0.074858,
    -0.307759,  0.100575, -0.551755,  0.000000,  0.000000, -1.000000,  0.923221,  0.074858,
    -0.307759, -0.167652, -0.551755,  0.000000,  0.000000, -1.000000,  0.923221,  0.490638,
    -0.307759,  0.100575, -0.551755,  1.000000,  0.000000,  0.000000,  0.111682,  0.178530,
    -0.307759,  0.100575, -0.512555,  1.000000,  0.000000,  0.000000,  0.030983,  0.178530,
    -0.307759, -0.167652, -0.512555,  1.000000,  0.000000,  0.000000,  0.030983,  0.730717,
    -0.307759,  0.100575, -0.512555,  0.000000,  0.000000,  1.000000,  0.540409,  0.043608,
    -0.472066,  0.100575, -0.512555,  0.000000,  0.000000,  1.000000,  0.285715,  0.043608,
    -0.472066, -0.167652, -0.512555,  0.000000,  0.000000,  1.000000,  0.285715,  0.459388,
    -0.307759, -0.167652, -0.551755,  0.000000, -1.000000,  0.000000,  0.893484,  0.609537,
    -0.307759, -0.167652, -0.512555,  0.000000, -1.000000,  0.000000,  0.893484,  0.739986,
    -0.472066, -0.167652, -0.512555,  0.000000, -1.000000,  0.000000,  0.346702,  0.739986,
    -0.472066,  0.100575, -0.551755,  0.000000,  1.000000,  0.000000,  0.303733,  0.812662,
    -0.472066,  0.100575, -0.512555,  0.000000,  1.000000,  0.000000,  0.303733,  0.943111,
    -0.307759,  0.100575, -0.512555,  0.000000,  1.000000,  0.000000,  0.850515,  0.943111,
};
const float *VERTS[NUM_MESHES] = {
    arr0,
    arr1,
    arr2,
    arr3
};

int main() {
    printf("\nRunning wfc test\n\n");

    printf("Converting %s...\n", INPUT_FILE);
    convertWavefront(INPUT_FILE);

    printf("Reading %s...\n", OUTPUT_FILE);
    
    FILE *file;
    file = fopen(OUTPUT_FILE, "rb");
    if(!file) {
        printf("ERROR opening %s\n", OUTPUT_FILE);
        perror("");
        exit(1);
    }

    // read .vrt data

    int num_meshes;
    fread(&num_meshes, sizeof(num_meshes), 1, file);

    if(num_meshes != NUM_MESHES) {
        printf("ERROR: num meshes does not match\n");
        printf("Expected: %d\n", NUM_MESHES);
        printf("Actual: %d\n", num_meshes);
        exit(1);
    }

    for(int i = 0; i < num_meshes; i ++) {
        // read texture file name
        int name_len;
        fread(&name_len, sizeof(name_len), 1, file);
        char *texname = malloc(name_len + 5);
        fread(texname, sizeof(*texname), name_len, file);
        texname[name_len] = '\0';
        strcat(texname, ".png\0");
        
        if(strcmp(texname, TEXNAMES[i]) != 0) {
            printf("ERROR: texnames do not match at mesh %d\n", i);
            printf("expected: %s\n", TEXNAMES[i]);
            printf("actual: %s\n", texname);
            exit(1);
        }

        free(texname);

        // read number of vertices in this mesh
        int num_verts;
        fread(&num_verts, sizeof(num_verts), 1, file);
        
        if(num_verts != NUM_VERTS[i]) {
            printf("ERROR: num_verts does not match at mesh %d\n", i);
            printf("expected: %d\n", NUM_VERTS[i]);
            printf("actual: %d\n", num_verts);
            exit(1);
        }

        float *verts = malloc(num_verts * FPV * sizeof(*verts));
        fread(verts, sizeof(*verts), FPV * num_verts, file);
        
        // check for matches here
        for(int j = 0; j < num_verts; j ++) {
            for(int k = 0; k < FPV; k ++) {
                float actual = verts[j * FPV + k];
                float expected = VERTS[i][j * FPV + k];
                // prints used for debugging
                /*if(out < 0 || *(unsigned int *)&out == 0x80000000) {
                    printf(" %f,", out);
                }
                else {
                    printf("  %f,", out);
                }*/
                if(fabs(actual - expected) > 0.000001) {
                    printf("ERROR: verts do not match at mesh %d\n", i);
                    printf("expected: %f\n", expected);
                    printf("actual: %f\n", actual);
                    printf("vertex: %d\n", j);
                    printf("index: %d\n", k);
                    exit(1);
                }
            }
            //printf("\n");
        }

        free(verts);
    }

    fclose(file);

    remove(OUTPUT_FILE);

    printf("Test passed\n");

    return 0;
}
